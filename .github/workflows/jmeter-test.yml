name: Run JMeter in Docker

on:
  workflow_dispatch:

jobs:
  jmeter-test:
    runs-on: self-hosted  # or ubuntu-latest if not local

    steps:
      - name: 🧾 Checkout repo
        run: echo "::group::Checkout repo" && pwd && ls -l && echo "::endgroup::"

      - name: 🛠️ Build Docker image for JMeter
        run: |
          echo "==> [1/3] Starting Docker build..."
          docker build -t jmeter-runner ./docker
          echo "==> [1/3] Docker build complete ✅"

      - name: 📂 List files in test directory
        run: |
          echo "==> [2/3] Listing files in tests/"
          ls -l ./tests || echo "⚠️ tests/ folder not found"

      - name: 🚀 Run JMeter test inside Docker
        run: |
          echo "==> [3/3] Running JMeter test..."
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests \
            jmeter-runner -n -t /tests/testplan.jmx -l /tests/results.jtl -j /tests/jmeter.log
          echo "✅ JMeter test completed"
